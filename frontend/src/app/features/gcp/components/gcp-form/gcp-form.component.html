<div class="gcp-container" *ngIf="config$ | async as config">
  <!-- Header -->
  <div class="gcp-header">
    <h1>{{ renderText(config.module.display.title) }}</h1>
    <p class="subtitle">{{ renderText(config.module.display.subtitle) }}</p>
    <mat-progress-bar 
      mode="determinate" 
      [value]="progress$ | async">
    </mat-progress-bar>
  </div>

  <!-- Current Section -->
  <mat-card class="section-card" *ngIf="currentSection$ | async as section">
    <mat-card-header>
      <mat-card-title>
        <ng-container *ngIf="section.type === 'info' && !hasUserName; else sectionTitle">
          Let's personalize this plan
        </ng-container>
        <ng-template #sectionTitle>
          {{ renderText(section.title) }}
        </ng-template>
      </mat-card-title>
      <mat-card-subtitle *ngIf="section.description">
        {{ renderText(section.description) }}
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Info section (intro, etc.) -->
      <ng-container *ngIf="section.type === 'info'; else questionSection">
        <div class="info-section">
          <ng-container *ngIf="hasUserName; else captureName">
            <div *ngIf="personalizedIntro?.length; else defaultIntro">
              <div *ngFor="let paragraph of personalizedIntro">
                <p>{{ paragraph }}</p>
              </div>
            </div>
            <ng-template #defaultIntro>
              <div *ngFor="let paragraph of section.content">
                <p>{{ renderText(paragraph) }}</p>
              </div>
            </ng-template>
            <div class="actions" *ngIf="section.actions">
              <button 
                mat-raised-button 
                *ngFor="let action of section.actions"
                (click)="handleInfoAction(action)"
                color="primary">
                {{ action.label }}
              </button>
            </div>
          </ng-container>
          <ng-template #captureName>
            <form [formGroup]="nameForm" class="name-capture" (ngSubmit)="confirmName()">
              <p>Before we begin, who are you answering for?</p>
              <mat-form-field appearance="fill">
                <mat-label>Care recipient name</mat-label>
                <input matInput formControlName="careRecipientName" autocomplete="off">
                <mat-error *ngIf="nameForm.controls['careRecipientName'].hasError('required')">
                  Please enter a name so Navi can personalize the plan.
                </mat-error>
              </mat-form-field>
              <button mat-raised-button color="primary" type="submit" [disabled]="nameForm.invalid">
                Continue
              </button>
            </form>
          </ng-template>
        </div>
      </ng-container>

      <!-- Question section -->
      <ng-template #questionSection>
        <div class="form-wrapper" *ngIf="currentSectionFields.length > 0">
          <form [formGroup]="form">
            <formly-form
              [form]="form"
              [fields]="currentSectionFields"
              [model]="model"
              [options]="options">
            </formly-form>
          </form>
        </div>
      </ng-template>
    </mat-card-content>

    <mat-card-actions align="end">
      <!-- Previous button -->
      <button 
        mat-button 
        (click)="onPrevious()"
        [disabled]="!(canGoPrevious$ | async)">
        <mat-icon>arrow_back</mat-icon>
        Previous
      </button>

      <!-- Next button -->
      <button 
        mat-raised-button 
        color="primary"
        (click)="onNext()"
        [disabled]="!(canGoNext$ | async) || !form.valid"
        *ngIf="!(isLastSection$ | async)">
        Next
        <mat-icon>arrow_forward</mat-icon>
      </button>

      <!-- Submit button -->
      <button 
        mat-raised-button 
        color="primary"
        (click)="onSubmit()"
        [disabled]="!form.valid || (submitting$ | async)"
        *ngIf="isLastSection$ | async">
        <mat-icon>check_circle</mat-icon>
        {{ (submitting$ | async) ? 'Submitting...' : 'Get Recommendation' }}
      </button>
    </mat-card-actions>
  </mat-card>
</div>

<!-- Loading state -->
<div class="loading-state" *ngIf="!(config$ | async)">
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  <p>Loading assessment...</p>
</div>
